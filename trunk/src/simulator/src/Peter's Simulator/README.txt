This code is a mess...